trigger:
  - master

pool:
  vmImage: ubuntu-latest

steps:
  - task: gitversion/setup@0
    displayName: 'Setup GitVersion'
    inputs:
      versionSpec: '0.1.x'

  - task: gitversion/execute@0
    displayName: 'Execute GitVersion'

  - task: Bash@3
    displayName: 'Set version number in package.json'
    inputs:
      targetType: 'inline'
      script: |
        PATTERN='s/"version": "*.*.*"/"version": "'$VERSION_NUMBER'"/g'
        sed -i "$PATTERN" package.json
    env:
      VERSION_NUMBER: $(GitVersion.SemVer)

  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Install Node.js'

  - script: |
      npm install -g vsce
      npm install
    displayName: 'Install vsce and dependencies'

  - script: |
      vsce package
    displayName: 'Package extension'

  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: |
        **/*.vsix
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)'
      artifact: 'extension'
      publishLocation: 'pipeline'

  - task: UniversalPackages@0
    inputs:
      command: 'publish'
      publishDirectory: '$(Build.ArtifactStagingDirectory)'
      feedsToUsePublish: 'internal'
      vstsFeedPublish: 'd7bdf2f6-a624-45ce-a264-701f6ff0cc3f/5d21d636-4e4f-4ae5-babf-051c32637bc1'
      vstsFeedPackagePublish: 'vsc-mes-scaffolding'
      versionOption: 'custom'
      versionPublish: '$(GitVersion.SemVer)'